<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zuarbeitsformular</title>
  <style>
  :root{
    --radius:12px;
    --bg:#e6ebf3;
    --card:#ffffff;
    --text:#0f172a;
    --border:#d1d5db;

    /* Blau (Default) */
    --blue-bg:#d7e6ff;
    --blue-bdr:#2f6df6;
    --blue-ring:rgba(47,109,246,.25);

    /* Gr√ºn (markiert) */
    --green-bg:#d2f7e6;
    --green-bdr:#0fa06d;
    --green-ring:rgba(15,160,109,.28);

    /* Tabellen */
    --thead-blue:#c4d7ff;
    --thead-green:#bff0d4;
    --zebra:#f3f6ff;
  }

  *{box-sizing:border-box}
  body{
    margin:18px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg); color:var(--text);
  }
  h1{margin-top:0;font-weight:800}

  /* Karte */
  form{max-width:1120px;margin:0 auto;padding:20px;background:var(--card);border:1px solid var(--border);border-radius:16px}

  /* Grid */
  :root{--gap:10px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap);align-items:start}
  .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-9{grid-column:span 9}.col-12{grid-column:span 12}

  label{font-weight:700;display:inline-block;margin:6px 0 3px}
  .hint{background:#f7fbff;border:1px solid #cfe8ff;padding:10px;border-radius:8px}

  /* DEFAULT = BLAU */
  input,select,textarea{
    width:100%;min-height:42px;padding:10px 12px;border-radius:var(--radius);
    border:2px solid var(--blue-bdr);background:var(--blue-bg);color:var(--text);
    outline:none;transition:box-shadow .18s,background-color .18s,border-color .18s;
  }
  input:focus,select:focus,textarea:focus{background:#fff;box-shadow:0 0 0 4px var(--blue-ring)}

  /* Buttons */
  .btn{padding:9px 14px;border-radius:10px;border:1px solid var(--border);background:#f8fafc;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:#2f6df6;color:#fff;border-color:#2f6df6}

  /* Fieldsets */
  fieldset{border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:18px;background:#fff}
  legend{padding:4px 10px;border-radius:999px;background:#eef2ff;border:1px solid var(--border);font-weight:800}

  /* Tabellen */
  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:9px 10px;border-bottom:1px solid var(--border);vertical-align:middle;text-align:left}
  th{background:var(--thead-blue);font-weight:800}
  tr:nth-child(even) td{background:var(--zebra)}
  #lesendeTable tbody tr:hover,#seminarleiterTable tbody tr:hover,#praktikumTable tbody tr:hover,#gesamtSwsTable tbody tr:hover{background:#eef3ff}

  /* Modul-Browser */
  #modulSelect{width:100%;height:12rem;border:2px solid var(--blue-bdr);background:var(--blue-bg);border-radius:12px}
  #moduleFilter{width:100%;border:2px solid var(--blue-bdr);background:var(--blue-bg);border-radius:10px}

  /* ==================== GR√úN: gew√ºnschte Felder ==================== */
  /* Einzel-Felder */
  #abgabetermin,
  #semester,
  #studiengang,
  #hochschule,
  #fakultaet,
  #fachsemester,
  #modulnummer,
  #modulbezeichnung,
  #fachart,
  /* SWS-Zellen */
  input[name="sws_v"],
  input[name="sws_s"],
  input[name="sws_p"]{
    background:var(--green-bg) !important;
    border-color:var(--green-bdr) !important;
  }
  #abgabetermin:focus,#semester:focus,#studiengang:focus,#hochschule:focus,#fakultaet:focus,#fachsemester:focus,
  #modulnummer:focus,#modulbezeichnung:focus,#fachart:focus,
  input[name="sws_v"]:focus,input[name="sws_s"]:focus,input[name="sws_p"]:focus{
    box-shadow:0 0 0 4px var(--green-ring) !important; background:#fff !important;
  }
  /* Hochschule ist readonly ‚Äì trotzdem gr√ºn & gut lesbar */
  #hochschule[readonly]{opacity:1;color:#0b1324;background:var(--green-bg)!important;border-color:var(--green-bdr)!important}

  /* SWS-√úberschriften (Vorlesung/Seminar/Praktikum) oben gr√ºn */
  #gesamtSwsTable tr:nth-child(2) th{background:var(--thead-green) !important}

  /* Tabellen: Spalten ‚ÄûFakult√§t ‚Äì Bereich / Titel, Name‚Äú UND ‚ÄûName‚Äú gr√ºn (Header + Inputs) */
  /* Lesende */
  #lesendeTable tr:first-child th:nth-child(1),
  #lesendeTable tr:first-child th:nth-child(2){background:var(--thead-green) !important}
  #lesendeTable td:nth-child(1) input,
  #lesendeTable td:nth-child(2) input{background:var(--green-bg)!important;border-color:var(--green-bdr)!important}
  /* Seminarleiter */
  #seminarleiterTable tr:first-child th:nth-child(1),
  #seminarleiterTable tr:first-child th:nth-child(2){background:var(--thead-green) !important}
  #seminarleiterTable td:nth-child(1) input,
  #seminarleiterTable td:nth-child(2) input{background:var(--green-bg)!important;border-color:var(--green-bdr)!important}
  /* Praktikum */
  #praktikumTable tr:first-child th:nth-child(1),
  #praktikumTable tr:first-child th:nth-child(2){background:var(--thead-green) !important}
  #praktikumTable td:nth-child(1) input,
  #praktikumTable td:nth-child(2) input{background:var(--green-bg)!important;border-color:var(--green-bdr)!important}
</style>

</head>
<body>
  <h1>üìù Zuarbeitsformular (Lehrveranstaltung)</h1>

  <form method="POST" action="/submit?type=zuarbeit">
    <fieldset>
      <legend>Allgemeine Angaben</legend>
      <div class="row">
        <div class="col-3">
          <label for="abgabetermin">Abgabetermin DS:</label>
          <input id="abgabetermin" name="abgabetermin" type="date" />
        </div>
        <div class="col-3">
          <label for="eingang">Eingang bei DS:</label>
          <input id="eingang" name="eingang" type="date" />
        </div>
        <div class="col-6">
          <label for="hochschule">Hochschule:</label>
          <input id="hochschule" name="hochschule" value="HTWK Leipzig" readonly />
        </div>
        <div class="col-6">
          <label for="semester">Semester:</label>
          <select name="semester" id="semester"></select>
        </div>
        <div class="col-6">
          <label for="fakultaet">Fakult√§t:</label>
          <select name="fakultaet" id="fakultaet"></select>
        </div>
        <div class="col-6">
          <label for="studiengang">Studiengang:</label>
          <input id="studiengang" name="studiengang" value="INB+MIB" />
        </div>
        <div class="col-3">
          <label for="fachsemester">Fachsemester:</label>
          <input id="fachsemester" name="fachsemester" type="number" min="0" />
        </div>
        <div class="col-9">
          <label for="gruppen">Gruppen:</label>
          <input id="gruppen" name="gruppen" type="text" placeholder="z. B. Gruppe 25INB-1, Gruppe 25MIB-1-2" />
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Modul / Lehrveranstaltung</legend>

      <!-- Modul-Browser (Filter + Liste) -->
      <div class="row" style="margin-bottom:10px;">
        <div class="col-12">
          <label for="modulSelect">Modul aus Liste ausw√§hlen:</label>
          <input id="moduleFilter" type="text" placeholder="Filtern nach Modulnr., Name, Verantwortliche ‚Ä¶">
          <select id="modulSelect" size="10"></select>
        </div>
      </div>

      <div class="row">
        <div class="col-4">
          <label for="modulnummer">Modulnummer:</label>
          <input id="modulnummer" name="modulnummer" type="text" />
        </div>
        <div class="col-8">
          <label for="modulbezeichnung">Modulbezeichnung:</label>
          <input id="modulbezeichnung" name="modulbezeichnung" type="text" />
        </div>
        <div class="col-4">
          <label for="teilmodulnummer">Teilmodulnummer:</label>
          <input id="teilmodulnummer" name="teilmodulnummer" type="text" />
        </div>
        <div class="col-8">
          <label for="teilmodulbezeichnung">Teilmodulbezeichnung:</label>
          <input id="teilmodulbezeichnung" name="teilmodulbezeichnung" type="text" />
        </div>
        <div class="col-6">
          <label for="fachart">Fachart (Pflicht- oder Wahlpflichtmodul):</label>
          <select name="fachart" id="fachart">
            <option value="">-- bitte w√§hlen --</option>
            <option value="Pflichtmodul">Pflichtmodul</option>
            <option value="Wahlpflichtmodul">Wahlpflichtmodul</option>
          </select>
        </div>
      </div>

      <div id="gesamtSwsTabelle" class="col-12" style="margin-top:12px;"></div>

      <p class="hint" style="margin-top:12px;">
        <strong>Hinweis:</strong> Die Buchung von Technik f√ºr den Campusbereich ist nur eine Voranmeldung. Die Nutzungsmodalit√§ten sind vom Lehrenden mit DT abzusprechen.
      </p>
      <p class="hint">
        <strong>Hinweis:</strong> 1 SWS = 1 WS (Wochenstunde: 45 min) in jeder Woche des Semesters; geplant werden nur Einheiten: 1 Einheit = 2 WS = 90 min
      </p>
    </fieldset>

    <fieldset>
      <legend>Lesende</legend>
      <button type="button" class="btn" id="lesendeAddBtn">‚ûï Zeile hinzuf√ºgen</button>
      <div id="lesendeTabelle" style="margin-top:8px;"></div>
    </fieldset>

    <fieldset>
      <legend>Seminarleiter</legend>
      <button type="button" class="btn" id="seminarleiterAddBtn">‚ûï Zeile hinzuf√ºgen</button>
      <div id="seminarleiterTabelle" style="margin-top:8px;"></div>
      <p style="margin-top:8px;">
        Bitte geben Sie an, ob die Seminare mit den einzelnen Seminargruppen, in mehreren Gruppen gemeinsam als H√∂rsaalseminar oder in anderen Varianten durchgef√ºhrt werden.
      </p>
    </fieldset>

    <fieldset>
      <legend>Praktikumsverantwortliche</legend>
      <button type="button" class="btn" id="praktikumAddBtn">‚ûï Zeile hinzuf√ºgen</button>
      <div id="praktikumTabelle" style="margin-top:8px;"></div>
    </fieldset>

    <fieldset>
      <legend>Konkrete Kalenderwochen</legend>
      <p>Ankreuzen oder beschriften:</p>
      <!-- Button entfernt: Kalender-Zeile wird genau einmal erzeugt -->
      <div id="planungsKalender" style="margin-top:8px;"></div>
    </fieldset>

    <div class="row" style="margin-top:16px;">
      <div class="col-12">
        <button type="submit" class="btn btn-primary">‚úÖ Speichern</button>
      </div>
    </div>
  </form>

  <p style="margin-top:12px;"><a href="/">Zur√ºck zur Auswahl</a></p>

  <!-- =============== Inline Scripts (vereint) =============== -->
  <script>
    // -------- semester.js --------
    function getCurrentSemester() {
      const now = new Date();
      const month = now.getMonth() + 1;
      const year = now.getFullYear();
      if (month >= 4 && month <= 9) {
        return `Sommersemester ${year}`;
      } else if (month >= 10) {
        const wsJahr1 = year;
        const wsJahr2 = (year + 1).toString().slice(-2);
        return `Wintersemester ${wsJahr1}/${wsJahr2}`;
      } else {
        const wsJahr1 = year - 1;
        const wsJahr2 = year.toString().slice(-2);
        return `Wintersemester ${wsJahr1}/${wsJahr2}`;
      }
    }

    // Neu: Parser + Planungssemester (n√§chstes Semester)
    function parseSemester(label){
      if (!label) return null;
      const s = label.match(/^Sommersemester\s+(\d{4})/i);
      if (s) return { type:'S', yStart: parseInt(s[1],10), yEnd: parseInt(s[1],10) };
      const w = label.match(/^Wintersemester\s+(\d{4})\/(\d{2})/i);
      if (w) {
        const yStart = parseInt(w[1],10);
        return { type:'W', yStart, yEnd: yStart+1 };
      }
      return null;
    }
    function getPlanningSemester(){
      const cur = getCurrentSemester();
      const info = parseSemester(cur);
      if (!info) return cur;
      if (info.type === 'S') {
        const y = info.yStart;
        return `Wintersemester ${y}/${(y+1).toString().slice(-2)}`;
      } else {
        return `Sommersemester ${info.yStart + 1}`;
      }
    }

    function fillSemesterList(selectId = 'semester', yearsBack = 5, yearsForward = 10) {
      const now = new Date();
      const currentYear = now.getFullYear();
      const startYear = currentYear - yearsBack;
      const endYear = currentYear + yearsForward;
      const semesterList = [];

      for (let y = startYear; y <= endYear; y++) {
        semesterList.push(`Sommersemester ${y}`);
        const wsJahr2 = (y + 1).toString().slice(-2);
        semesterList.push(`Wintersemester ${y}/${wsJahr2}`);
      }

      const select = document.getElementById(selectId);
      if (!select) return;
      const defaultSemester = getPlanningSemester(); // Planung: n√§chstes Semester
      semesterList.forEach(sem => {
        const opt = document.createElement('option');
        opt.value = sem;
        opt.textContent = sem;
        if (sem === defaultSemester) opt.selected = true;
        select.appendChild(opt);
      });
    }

    document.addEventListener('DOMContentLoaded', () => fillSemesterList());

    // -------- fakultaet.js --------
    const fakultaetListe = [
      "",
      "FAS",
      "FB",
      "FDIT",
      "FIM-INF",
      "FING",
      "FWW",
      "HSZ",
      "MNZ",
      "Gast",
      "HonProf"
    ];

    function fillFakultaetList(selectId = "fakultaet", list = fakultaetListe) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = "";
      list.forEach(fak => {
        const opt = document.createElement("option");
        opt.value = fak;
        opt.textContent = fak;
        if (fak === "FIM-INF") {
          opt.selected = true; // Vorauswahl
        }
        select.appendChild(opt);
      });
    }

    document.addEventListener("DOMContentLoaded", () => fillFakultaetList());

    // -------- gesamtSwsTabelle.js --------
    document.addEventListener("DOMContentLoaded", function () {
      const container = document.getElementById("gesamtSwsTabelle");
      const spalten = ["Vorlesung", "Seminar", "Praktikum"];
      const zeilen = [
        { label: "davon SWS", typ: "number", namen: ["sws_v", "sws_s", "sws_p"], werte: [2, 2, 0] },
        { label: "Raumanforderung", typ: "text", namen: ["raum_v", "raum_s", "raum_p"], werte: ["", "", ""] },
        { label: "Technikanforderung (Campus ‚Äì Bereich)", typ: "text", namen: ["technik_v", "technik_s", "technik_p"], werte: ["Beamer/WLAN", "", ""] }
      ];

      const table = document.createElement("table");
      table.id = "gesamtSwsTable";

      // Kopfzeile
      const headerRow = table.insertRow();
      const headerCell = document.createElement("td");
      headerCell.colSpan = 4;
      headerCell.innerHTML = `<strong>Gesamt SWS (bezogen auf einen Beispiel-Studenten):</strong> <span id="gesamtSwsWert">0</span>`;
      headerRow.appendChild(headerCell);

      // Spalten√ºberschriften
      const spaltenRow = table.insertRow();
      spaltenRow.insertCell(); // leer
      spalten.forEach(s => {
        const th = document.createElement("th");
        th.textContent = s;
        spaltenRow.appendChild(th);
      });

      // Inhalte
      zeilen.forEach((zeile) => {
        const row = table.insertRow();
        const labelCell = row.insertCell();
        labelCell.textContent = zeile.label;

        zeile.namen.forEach((feldName, sIndex) => {
          const cell = row.insertCell();
          const input = document.createElement("input");
          input.name = feldName;
          input.style.width = "120px";
          input.style.fontWeight = "bold";
          input.value = zeile.werte[sIndex];
          input.type = zeile.typ === "number" ? "number" : "text";
          if (zeile.typ === "number") {
            input.min = 0;
            input.addEventListener("input", updateGesamtSws);
          }
          cell.appendChild(input);
        });
      });

      container.appendChild(table);
      updateGesamtSws();

      function updateGesamtSws() {
        const v = parseInt(document.querySelector('[name="sws_v"]').value) || 0;
        const s = parseInt(document.querySelector('[name="sws_s"]').value) || 0;
        const p = parseInt(document.querySelector('[name="sws_p"]').value) || 0;
        document.getElementById("gesamtSwsWert").textContent = v + s + p;
      }
    });

    // -------- lesende.js (korrigiert) --------
    let lesendeZaehler = 0;
    document.addEventListener("DOMContentLoaded", function() {
      const btn = document.getElementById("lesendeAddBtn");
      if (btn) btn.addEventListener("click", addLesendeRow);
      addLesendeRow(); // Erste Zeile automatisch
    });

    function addLesendeRow() {
      const tableDiv = document.getElementById("lesendeTabelle");
      if (!document.getElementById("lesendeTable")) {
        tableDiv.innerHTML = `
          <table border="1" style="border-collapse:collapse;width:100%;" id="lesendeTable">
            <tr>
              <th>Fakult√§t ‚Äì Bereich / Titel, Name</th>
              <th>Name</th>
              <th>Seminargruppe</th>
              <th>Erl√§uterung</th>
              <th> </th>
            </tr>
          </table>
        `;
      }
      lesendeZaehler++;
      const table = document.getElementById("lesendeTable");
      const row = table.insertRow(-1);
      row.innerHTML = `
        <td><input name="lesende_fakultaet_${lesendeZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><input name="lesende_name_${lesendeZaehler}"      style="width:99%;font-weight:bold" /></td>
        <td><input name="lesende_gruppe_${lesendeZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><input name="lesende_erklaerung_${lesendeZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><button type="button" class="btn" onclick="removeLesendeRow(this)">üóëÔ∏è</button></td>
      `;
    }

    function removeLesendeRow(btn) {
      const table = document.getElementById("lesendeTable");
      if (!table) return;
      // mind. 1 Datenzeile behalten (1 Header + 1 Datenzeile = 2 rows)
      if (table.rows.length > 2) {
        const row = btn.closest('tr');
        row.parentNode.removeChild(row);
      }
    }
    window.removeLesendeRow = removeLesendeRow;


    // -------- seminarleiter.js --------
    let seminarleiterZaehler = 0;
    document.addEventListener("DOMContentLoaded", function() {
      const btn = document.getElementById("seminarleiterAddBtn");
      if (btn) btn.addEventListener("click", addSeminarleiterRow);
      // KEIN auto add ‚Äì abh√§ngig von SWS_S
    });

    function addSeminarleiterRow() {
      const tableDiv = document.getElementById("seminarleiterTabelle");
      if (!document.getElementById("seminarleiterTable")) {
        tableDiv.innerHTML = `
          <table border="1" style="border-collapse:collapse;width:100%;" id="seminarleiterTable">
            <tr>
              <th>Fakult√§t ‚Äì Bereich / Titel, Name</th>
              <th>Name</th>
              <th>Seminargruppe</th>
              <th>Erl√§uterung</th>
              <th></th>
            </tr>
          </table>
        `;
      }
      seminarleiterZaehler++;
      const table = document.getElementById("seminarleiterTable");
      const row = table.insertRow(-1);
      row.innerHTML = `
        <td><input name="seminarleiter_fakultaet_${seminarleiterZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><input name="seminarleiter_name_${seminarleiterZaehler}"        style="width:99%;font-weight:bold" /></td>
        <td><input name="seminarleiter_gruppe_${seminarleiterZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><input name="seminarleiter_erklaerung_${seminarleiterZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><button type="button" class="btn" onclick="removeSeminarleiterRow(this)">üóëÔ∏è</button></td>
      `;
    }

    function removeSeminarleiterRow(btn) {
      const table = document.getElementById("seminarleiterTable");
      if (table && table.rows.length > 2) {
        const row = btn.closest('tr');
        row.parentNode.removeChild(row);
      }
    }
    window.removeSeminarleiterRow = removeSeminarleiterRow;

    // -------- praktikumsverantwortliche.js --------
    let praktikumZaehler = 0;
    document.addEventListener("DOMContentLoaded", function() {
      const btn = document.getElementById("praktikumAddBtn");
      if (btn) btn.addEventListener("click", addPraktikumRow);
      // KEIN auto add ‚Äì abh√§ngig von SWS_P
    });

    function addPraktikumRow() {
      const tableDiv = document.getElementById("praktikumTabelle");
      if (!document.getElementById("praktikumTable")) {
        tableDiv.innerHTML = `
          <table border="1" style="border-collapse:collapse;width:100%;" id="praktikumTable">
            <tr>
              <th>Fakult√§t ‚Äì Bereich / Titel, Name</th>
              <th>Name</th>
              <th>Seminargruppe</th>
              <th>Erl√§uterung</th>
              <th></th>
            </tr>
          </table>
        `;
      }
      praktikumZaehler++;
      const table = document.getElementById("praktikumTable");
      const row = table.insertRow(-1);
      row.innerHTML = `
        <td><input name="praktikum_fakultaet_${praktikumZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><input name="praktikum_name_${praktikumZaehler}"        style="width:99%;font-weight:bold" /></td>
        <td><input name="praktikum_gruppe_${praktikumZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><input name="praktikum_erklaerung_${praktikumZaehler}" style="width:99%;font-weight:bold" /></td>
        <td><button type="button" class="btn" onclick="removePraktikumRow(this)">üóëÔ∏è</button></td>
      `;
    }

    function removePraktikumRow(btn) {
      const table = document.getElementById("praktikumTable");
      if (table && table.rows.length > 2) {
        const row = btn.closest('tr');
        row.parentNode.removeChild(row);
      }
    }
    window.removePraktikumRow = removePraktikumRow;

    // -------- Abgabetermin automatisch aus Semester --------
    function updateAbgabeterminFromSemester(){
      const s = document.getElementById('semester');
      const abgabe = document.getElementById('abgabetermin');
      if (!s || !abgabe) return;
      const info = parseSemester(s.value);
      if (!info) return;

      if (info.type === 'S') {
        // SoSe YYYY -> 01.04.YYYY
        abgabe.value = `${info.yStart}-04-01`;
      } else {
        // WiSe YYYY/YY -> 01.10.YYYY (kleinstes Jahr)
        abgabe.value = `${info.yStart}-10-01`;
      }
    }

    // -------- ISO-KW & Wochenbereiche f√ºr Semester --------
    function isoWeekNumber(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    function weeksBetween(start, end){
      const weeks = [];
      const seen = new Set();
      const d = new Date(start);
      while (d <= end) {
        const w = isoWeekNumber(d);
        if (!seen.has(w)) { weeks.push(w); seen.add(w); }
        d.setDate(d.getDate() + 1);
      }
      return weeks;
    }
    function getSelectedSemesterLabel(){
      const sel = document.getElementById('semester');
      return sel?.value || '';
    }
    function getWeeksForSemester(semLabel){
      const info = parseSemester(semLabel);
      if (!info) return [];
      if (info.type === 'S') {
        // SoSe: 01.04.‚Äì31.07. (+ Pr√ºfungs-KW ~ Ende September)
        const start = new Date(info.yStart, 3, 1);   // Apr
        const end   = new Date(info.yStart, 6, 31);  // Jul
        const weeks = weeksBetween(start, end);
        const examW = isoWeekNumber(new Date(info.yStart, 8, 25)); // ~25. Sep (typ. KW ~39)
        if (!weeks.includes(examW)) weeks.push(examW);
        return weeks;
      } else {
        // WiSe: 01.10.‚Äì31.01. (Jahreswechsel)
        const start = new Date(info.yStart,     9, 1);  // Oct
        const end   = new Date(info.yStart + 1, 0, 31); // Jan
        return weeksBetween(start, end);
      }
    }
    function rebuildPlanungsKalenderTable(){
      const container = document.getElementById("planungsKalender");
      if (!container) return;
      container.innerHTML = "";
      if (typeof planungsKalenderZaehler !== 'undefined') planungsKalenderZaehler = 0;
      addPlanungsKalenderRow(); // erzeugt genau eine (Doppel-)Zeile
    }

    // -------- planungsKalender.js (dynamische KWs; exakt eine Zeile) --------
    let planungsKalenderZaehler = 0;
    document.addEventListener("DOMContentLoaded", function () {
      // nach dem F√ºllen der Semesterliste: Abgabetermin & KWs initial setzen
      updateAbgabeterminFromSemester();
      addPlanungsKalenderRow(); // nur eine Zeile
    });

    function addPlanungsKalenderRow() {
      const container = document.getElementById("planungsKalender");
      const wochen = getWeeksForSemester(getSelectedSemesterLabel()); // dynamisch aus Semester

      let table = document.getElementById("planungsKalenderTable");
      if (!table) {
        table = document.createElement("table");
        table.border = "1";
        table.style.borderCollapse = "collapse";
        table.id = "planungsKalenderTable";

        const headRow = table.insertRow();
        wochen.forEach(w => {
          const th = document.createElement("th");
          th.textContent = w;
          headRow.appendChild(th);
        });
        const thName = document.createElement("th");
        thName.textContent = "Name";
        headRow.appendChild(thName);

        container.innerHTML = "";
        container.appendChild(table);
      }

      // Wenn bereits eine Datenzeile existiert, nicht noch eine hinzuf√ºgen
      const hasRow = table.querySelector('tr[data-id]');
      if (hasRow) return;

      planungsKalenderZaehler++;
      const zeilenId = planungsKalenderZaehler;

      const row1 = table.insertRow(-1);
      row1.setAttribute("data-id", zeilenId);

      wochen.forEach(w => {
        const td = row1.insertCell();
        if (w === 39) {
          td.rowSpan = 2;
          td.innerHTML = `<div style="font-size:smaller;">Pr√ºfung</div><input type="checkbox" name="kw_pruefung_${zeilenId}">`;
          td.style.minWidth = "50px";
        } else {
          td.innerHTML = `<input type="checkbox" name="kw_${w}_${zeilenId}">`;
        }
      });

      const nameTd = row1.insertCell();
      nameTd.rowSpan = 2;
      nameTd.innerHTML = `
        <input name="planungs_name_${zeilenId}" style="width:140px" placeholder="Name" />
      `;

      const row2 = table.insertRow(-1);
      row2.setAttribute("data-id", zeilenId);
      wochen.forEach(w => {
        if (w === 39) return; // schon oben mit Rowspan
        const td = row2.insertCell();
        td.innerHTML = `<input type="text" name="kwtxt_${w}_${zeilenId}" style="width:42px;" placeholder="KW" title="Kurztext f√ºr KW ${w}">`;
      });
    }

    // ===== Module-Browser + Autofill =====
    let MODULES = [];
    const modulesById = {};

    function nf(x){ const n = Number(x); return Number.isFinite(n) ? Math.max(0, n) : ''; }

    function intOrEmpty(v) {
      const m = String(v ?? '').match(/\d+/);
      return m ? parseInt(m[0], 10) : '';
    }

    function setSemesterFromTurnus(turnus) {
      if (!turnus) return;
      const s = document.getElementById('semester');
      if (!s) return;
      const now = new Date();
      let target = '';
      if (turnus.toLowerCase().startsWith('winter')) {
        const y = (now.getMonth()+1 >= 10) ? now.getFullYear() : now.getFullYear()-1;
        target = `Wintersemester ${y}/${(y+1).toString().slice(-2)}`;
      } else if (turnus.toLowerCase().startsWith('sommer')) {
        target = `Sommersemester ${now.getFullYear()}`;
      }
      const opt = Array.from(s.options).find(o => o.textContent === target);
      if (opt) s.value = opt.value;
    }

    function inferStudiengang(mod, auf){
      const g = (auf && typeof auf.Gruppen === 'string') ? auf.Gruppen : '';
      if (g.includes('INB')) return 'INB';
      if (g.includes('MIB')) return 'MIB';
      if (Array.isArray(mod?.ZusammenMit) && mod.ZusammenMit.length) return mod.ZusammenMit.join('+');
      return '';
    }

    function setIfEmpty(el, val){ if (el && !el.value && val != null) el.value = val; }
    function setFakultaetSmart(value){
      const sel = document.getElementById('fakultaet');
      if (!sel || !value) return;
      if (![...sel.options].some(o => o.value === value)) {
        const opt = document.createElement('option'); opt.value = value; opt.textContent = value; sel.appendChild(opt);
      }
      if (!sel.value || sel.value === 'FIM-INF') sel.value = value;
    }
    function setSwsValues(v,s,p){
      const iv = document.querySelector('[name="sws_v"]');
      const is = document.querySelector('[name="sws_s"]');
      const ip = document.querySelector('[name="sws_p"]');
      if (iv){ iv.value = v || 0; iv.dispatchEvent(new Event('input', {bubbles:true})); }
      if (is){ is.value = s || 0; is.dispatchEvent(new Event('input', {bubbles:true})); }
      if (ip){ ip.value = p || 0; ip.dispatchEvent(new Event('input', {bubbles:true})); }
      const span = document.getElementById('gesamtSwsWert');
      if (span){
        const vv = parseInt(iv?.value||0)||0, ss = parseInt(is?.value||0)||0, pp = parseInt(ip?.value||0)||0;
        span.textContent = vv + ss + pp;
      }
    }

    // Helfer f√ºr die Tabellen
    function clearTableRows(tableId){
      const t = document.getElementById(tableId);
      if (!t) return;
      while (t.rows.length > 1) t.deleteRow(1); // Header behalten
    }
    function tableHasData(tableId){
      const t = document.getElementById(tableId);
      return !!(t && t.rows.length > 1);
    }

    function fillModuleSelect(list){
      const sel = document.getElementById('modulSelect');
      if (!sel) return;
      sel.innerHTML = '';
      list.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.Modulnummer;
        opt.textContent = m.Modulnummer + ' ‚Äî ' + m.Modulbezeichnung;
        const searchBlob = [
          m.Modulnummer,
          m.Modulbezeichnung,
          (m.ZusammenMit||[]).join(' '),
          m?.Modulverantwortliche?.Vorname,
          m?.Modulverantwortliche?.Nachname
        ].filter(Boolean).join(' ').toLowerCase();
        opt.dataset.search = searchBlob;
        sel.appendChild(opt);
      });
    }

    async function loadModules(){
      try {
        const res = await fetch('/api/module', { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('HTTP '+res.status);
        MODULES = await res.json();
      } catch (apiErr) {
        try {
          const embedded = document.getElementById('moduleJson');
          if (embedded) {
            MODULES = JSON.parse(embedded.textContent);
          } else {
            const res2 = await fetch('/modules.json');
            if (!res2.ok) throw new Error('HTTP '+res2.status);
            MODULES = await res2.json();
          }
        } catch (fallbackErr) {
          console.error('Module konnten nicht geladen werden:', apiErr, fallbackErr);
          MODULES = [];
        }
      }

      MODULES.forEach(m => { modulesById[m.Modulnummer] = m; });

      const extraFaks = Array.from(new Set(MODULES.map(m => m.Fakult√§t).filter(Boolean)));
      extraFaks.forEach(f => { if (!fakultaetListe.includes(f)) fakultaetListe.push(f); });
      fillFakultaetList();

      fillModuleSelect(MODULES);
    }

    function applyModuleToForm(mod){
      const modulnummer = document.getElementById('modulnummer');
      const modulbez   = document.getElementById('modulbezeichnung');
      if (modulnummer) modulnummer.value = mod.Modulnummer || '';
      if (modulbez)    modulbez.value    = mod.Modulbezeichnung || '';

      if (mod?.Turnus) setSemesterFromTurnus(mod.Turnus);
      setFakultaetSmart(mod.Fakult√§t || '');
      const sg = document.getElementById('studiengang');
      if (sg) setIfEmpty(sg, (Array.isArray(mod.ZusammenMit) && mod.ZusammenMit.length) ? mod.ZusammenMit.join('+') : '');

      const fa = document.getElementById('fachart');
      if (fa) {
        const mt = (mod?.Modultyp || '').toString().trim().toUpperCase();
        if (mt === 'PF')      fa.value = 'Pflichtmodul';
        else if (mt === 'WPF') fa.value = 'Wahlpflichtmodul';
        else if (!fa.value && mod?.Fachart && [...fa.options].some(o => o.value === mod.Fachart)) {
          fa.value = mod.Fachart;
        }
      }

      // Fachsemester aus dem Modul √ºbernehmen
      const fsEl = document.getElementById('fachsemester');
      if (fsEl) {
        const fs = intOrEmpty(mod.Fachsemester);
        fsEl.value = (fs !== '') ? fs : '';
      }

      const lv = mod?.Lehrveranstaltungen || {};
      setSwsValues(nf(lv.SWS_V), nf(lv.SWS_S), nf(lv.SWS_P));

      // === Lesende automatisch ausf√ºllen (Name + Fakult√§t) ===
      (function () {
        const mv  = mod?.Modulverantwortliche || {};
        const fak = mod?.Fakult√§t || '';
        const fullname = [mv.Anrede, mv.Vorname, mv.Nachname]
          .filter(Boolean).join(' ').replace(/\s+/g, ' ').trim();

        if (!document.querySelector('input[name^="lesende_name_"]')) {
          const btn = document.getElementById('lesendeAddBtn');
          if (btn) btn.click();
        }
        const nameInput = document.querySelector('input[name^="lesende_name_"]');
        const fakInput  = document.querySelector('input[name^="lesende_fakultaet_"]');

        setIfEmpty(nameInput, fullname);
        setIfEmpty(fakInput,  fak);
      })();

      // --- Seminarleiter: nur wenn SWS_S > 0 ---
      const swsS = Number(lv.SWS_S) || 0;
      clearTableRows('seminarleiterTable');
      if (swsS > 0) {
        const mv  = mod?.Modulverantwortliche || {};
        const fak = mod?.Fakult√§t || '';
        const fullname = [mv.Anrede, mv.Vorname, mv.Nachname].filter(Boolean).join(' ').replace(/\s+/g,' ').trim();

        if (!tableHasData('seminarleiterTable')) {
          document.getElementById('seminarleiterAddBtn')?.click(); // erzeugt Table + 1 Zeile
        }
        const nameInput = document.querySelector('input[name^="seminarleiter_name_"]');
        const fakInput  = document.querySelector('input[name^="seminarleiter_fakultaet_"]');
        if (fullname) setIfEmpty(nameInput, fullname);
        if (fak)      setIfEmpty(fakInput,  fak);
      }

      // --- Praktikum: nur wenn SWS_P > 0 ---
      const swsP = Number(lv.SWS_P) || 0;
      clearTableRows('praktikumTable');
      if (swsP > 0) {
        const mv  = mod?.Modulverantwortliche || {};
        const fak = mod?.Fakult√§t || '';
        const thefullname = [mv.Anrede, mv.Vorname, mv.Nachname].filter(Boolean).join(' ').replace(/\s+/g,' ').trim();

        if (!tableHasData('praktikumTable')) {
          document.getElementById('praktikumAddBtn')?.click();
        }
        const nameInput = document.querySelector('input[name^="praktikum_name_"]');
        const fakInput  = document.querySelector('input[name^="praktikum_fakultaet_"]');
        if (thefullname) setIfEmpty(nameInput, thefullname);
        if (fak)         setIfEmpty(fakInput,  fak);
      }

      // nach evtl. Semester-Setzung aus Modul -> Abgabetermin & KWs aktualisieren
      updateAbgabeterminFromSemester();
      rebuildPlanungsKalenderTable();
    }

    function applySelectedModule(){
      const sel = document.getElementById('modulSelect');
      if (!sel || !sel.value) return;
      const mod = modulesById[sel.value];
      if (mod) applyModuleToForm(mod);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sel = document.getElementById('modulSelect');
      const filter = document.getElementById('moduleFilter');

      if (filter && sel){
        filter.addEventListener('input', () => {
          const q = filter.value.trim().toLowerCase();
          Array.from(sel.options).forEach(opt => {
            opt.hidden = q && !(opt.dataset.search || '').includes(q);
          });
        });
      }
      if (sel) sel.addEventListener('change', applySelectedModule);

      const mn = document.getElementById('modulnummer');
      if (mn) mn.addEventListener('change', async () => {
        const id = mn.value.trim();
        if (modulesById[id]) {
          applyModuleToForm(modulesById[id]);
        } else {
          await ladeModulDaten_viaEndpoint(id); // Fallback
        }
      });

      // Semester-√Ñnderung -> Abgabetermin & KW-Grid aktualisieren
      const semSel = document.getElementById('semester');
      if (semSel) {
        semSel.addEventListener('change', () => {
          updateAbgabeterminFromSemester();
          rebuildPlanungsKalenderTable();
        });
      }

      // Live-Sync, wenn SWS manuell ge√§ndert werden
      const swsSInput = document.querySelector('[name="sws_s"]');
      const swsPInput = document.querySelector('[name="sws_p"]');
      function syncSectionsBySws(){
        const s = Number(swsSInput?.value)||0;
        const p = Number(swsPInput?.value)||0;

        if (s === 0) {
          clearTableRows('seminarleiterTable');
        } else if (!tableHasData('seminarleiterTable')) {
          document.getElementById('seminarleiterAddBtn')?.click();
        }

        if (p === 0) {
          clearTableRows('praktikumTable');
        } else if (!tableHasData('praktikumTable')) {
          document.getElementById('praktikumAddBtn')?.click();
        }
      }
      swsSInput?.addEventListener('input', syncSectionsBySws);
      swsPInput?.addEventListener('input', syncSectionsBySws);

      loadModules();
    });

    async function ladeModulDaten_viaEndpoint(nummer){
      if (!nummer) return;
      try {
        const res = await fetch(`/modul/${encodeURIComponent(nummer)}`);
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById("modulbezeichnung").value = data.modulbezeichnung || data.Modulbezeichnung || "";
        const fa = document.getElementById('fachart');
        if (fa) {
          const mt = (data.Modultyp || '').toString().trim().toUpperCase();
          if (mt === 'PF')      fa.value = 'Pflichtmodul';
          else if (mt === 'WPF') fa.value = 'Wahlpflichtmodul';
        }
        // Fachsemester ggf. aus Fallback setzen
        const fsEl = document.getElementById('fachsemester');
        if (fsEl) {
          const fs = intOrEmpty(data.Fachsemester || data.fachsemester);
          fsEl.value = (fs !== '') ? fs : '';
        }
        updateAbgabeterminFromSemester();
        rebuildPlanungsKalenderTable();
      } catch (e) {
        console.warn("Konnte Moduldaten nicht laden:", e);
      }
    }

    // Beim Laden sicherstellen, dass Abgabetermin initial korrekt ist
    document.addEventListener('DOMContentLoaded', () => {
      updateAbgabeterminFromSemester();
    });
  </script>

  <!-- Optionaler Offline-Fallback:
  <script type="application/json" id="moduleJson">[ /* ‚Ä¶ deine Module ‚Ä¶ */ ]</script>
  -->
</body>
</html>
